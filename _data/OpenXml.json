{"Data":{"Sdk":{"Events":[{"Id":"15902047172","Type":"IssuesEvent","CreatedAt":"2021-04-12T08:21:57","Actor":"sdudnic","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"opened","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/issues/919","RelatedDescription":"Opened issue \"Copy pictures from one generated Word document to another one\" (#919) at OfficeDev/Open-XML-SDK","RelatedBody":"# Before submitting an issue, please fill this out\r\n\r\nIs this a:\r\n- [ ] Issue with the OpenXml library\r\n- [x] Question on library usage\r\n\r\nI ask here, because I had any answer [on StackOverflow](https://stackoverflow.com/questions/67038242) for several weeks.\r\n\r\n---------------- Remove this line and above before posting ----------------\r\n\r\n**Description**\r\n\r\nI generate an SSRS report that I save as a Word document. That document contain pictures (charts as plat images). \r\nI don't really save the Word document, I have it open in memory.\r\n\r\nI use then OpenXML to create another word document, in witch I need to copy the pictures from the SSRS report.   \r\n\r\nI try to get the drawings from the ssrs report, and insert them in the new word document.\r\n\r\nI tried to insert pictures from the disk to the generated document, that works well. What does not work, is copying one picture from one document to another. \r\nI don't need to copy all the content of a document to another. I need to copy just a picture.\r\n\r\n**Information**\r\n\r\n- .NET Target: .NET 5\r\n- DocumentFormat.OpenXml Version: 2.12.3\r\n\r\n**Repro**\r\n\r\n```csharp\r\nMainDocumentPart ssrsMainPart = ssrsDoc.MainDocumentPart;\r\nvar drawings = ssrsMainPart.Document.Descendants<Drawing>().ToList();\r\n```\r\nand then insert it in the new document\r\n```csharp\r\nMainDocumentPart mainPart = wordDoc.MainDocumentPart;\r\nBody body = mainPart.Document.Body;\r\n```\r\n```csharp\r\nfor (int i = 0; i < 10; i++)\r\n{\r\n    if (i < drawings.Count())\r\n    {\r\n        var myDrawing = drawings.Skip(i).First();\r\n        myDrawing.Remove();\r\n        body.Append(myDrawing); \r\n        body.Append(new Paragraph());\r\n    }\r\n}\r\n```\r\nAs result I get in the resulting document only the picture placeholders, of the same size as in ssrs Word Document, but the pictures are empty. \r\n\r\nI tried to copy the ImageData as well, using the following code:\r\n\r\n```csharp\r\nforeach (var e in ssrsDoc.MainDocumentPart.Document.Body.Elements())\r\n{\r\n\tvar clonedElement = e.CloneNode(true);\r\n\tclonedElement.Descendants<DocumentFormat.OpenXml.Drawing.Blip>().ToList().ForEach(blip =>\r\n\t{\r\n\t\tvar newRelation = wordDoc.CopyImage(blip.Embed, ssrsDoc);\r\n\t\tblip.Embed = newRelation;\r\n\t});\r\n\tclonedElement.Descendants<DocumentFormat.OpenXml.Vml.ImageData>().ToList().ForEach(imageData =>\r\n\t{\r\n\t\tvar newRelation = wordDoc.CopyImage(imageData.RelationshipId, ssrsDoc);\r\n\t\timageData.RelationshipId = newRelation;\r\n\t});\r\n\twordDoc.MainDocumentPart.Document.Body.AppendChild(clonedElement);\r\n}\r\n```\r\nwith CopyImage defined like this:\r\n```csharp\r\npublic static string CopyImage(this WordprocessingDocument newDoc, string relId, WordprocessingDocument org)\r\n{\r\n\tvar p = org.MainDocumentPart.GetPartById(relId) as ImagePart;\r\n\tvar newPart = newDoc.MainDocumentPart.AddPart(p);\r\n\tnewPart.FeedData(p.GetStream());\r\n\treturn newDoc.MainDocumentPart.GetIdOfPart(newPart);\r\n}\r\n``` \r\n\r\nbut after that I wasn't able to open anymore the document with Word 365, word reporting the doc as a broken one...\r\n"},{"Id":"15877954887","Type":"IssuesEvent","CreatedAt":"2021-04-09T10:19:26","Actor":"rubansergey","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"opened","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/issues/918","RelatedDescription":"Opened issue \"OpenXml validation works slow starting from version 2.11.3\" (#918) at OfficeDev/Open-XML-SDK","RelatedBody":"- Issue with the OpenXml library\r\n\r\nWe have a customer's Wordprocessing document **with a lot of tracked changes** that hangs after we update OpenXml.\r\n\r\nImvestigation shows that:\r\n- It hangs when we call OpenXmlValidator's **Validate** method against MainDocumentPart of this document. \r\n- It works quick on version 2.11.2\r\n- It was broken of version 2.11.3 I have reviewed [changelog ](https://github.com/OfficeDev/Open-XML-SDK/blob/main/CHANGELOG.md)and there is no information that means improvement quality or making algorithm of validation  more complex. Against, there were some performance improvements like removing recursion. **This points to think that there was some side effect in this build that causes such performance impact**.\r\n- Version 2.12.0 has a CancellationToken support which is great, but is more like a workaround for our situation than a fix, as we still want to validate parts as quick as before.\r\n\r\nAfter this innitial investigation I ran main branch with such simple code added against CPU profiler:\r\n\r\n`namespace ConsoleApp1\r\n{\r\n    class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n            using (var doc = WordprocessingDocument.Open(@\"d:\\xxxxxx\\Workspace\\Desk\\Sample.docx\", false))\r\n            {\r\n                var validator = new OpenXmlValidator();\r\n                validator.Validate(doc.MainDocumentPart);\r\n            }\r\n        }\r\n    }\r\n}`\r\n\r\nProfiler shows that currently the slovest method is DocumentFormat.OpenXml.Validation.ValidationTraverser **ValidatingTraverse** \r\n![image](https://user-images.githubusercontent.com/52368905/114165458-2ea7d700-9935-11eb-825e-2c7063cc63a3.png)\r\n\r\nAt this point my investigation stops as I do not have a brunch with build before this method starts works slow and this will be out of scope of my investigation, but I think given information should be enough to at least point to the issue.\r\n\r\nAlso see attached sample document and VS profiller dump file \r\n[Sample.docx](https://github.com/OfficeDev/Open-XML-SDK/files/6284918/Sample.docx)\r\n[Report20210409-1040.zip](https://github.com/OfficeDev/Open-XML-SDK/files/6284919/Report20210409-1040.zip)\r\n\r\n\r\n\r\n\r\n\r\n"},{"Id":"15852322093","Type":"IssuesEvent","CreatedAt":"2021-04-07T18:50:56","Actor":"Pxtl","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"opened","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/issues/917","RelatedDescription":"Opened issue \"AddAlternativeFormatImportPart produces malformed documents if both parent and child contain shape-lines or similar objects\" (#917) at OfficeDev/Open-XML-SDK","RelatedBody":"**Description**\r\n\r\nDocument is malformed if I use AddAlternativeFormatImportPart on a document with a shape-line (or similar objects) in the root *and* the attached documents.\r\n\r\n**Information**\r\n\r\n- .NET Target: .NET Framework 4.6.2\r\n- DocumentFormat.OpenXml Version: 2.12.3\r\n\r\n**Repro**\r\n\r\nCreate 2 word documents \"Template.docx\" and \"ExampleAttachment.docx\".  Insert a single shape-line in both.\r\nNote this was originally discovered using a shape-line and an attached image, but it can work with a shape-line.\r\n\r\n```csharp\r\nusing DocumentFormat.OpenXml;\r\nusing DocumentFormat.OpenXml.Packaging;\r\nusing DocumentFormat.OpenXml.Wordprocessing;\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.IO;\r\nusing System.Linq;\r\nusing System.Text;\r\nusing System.Threading.Tasks;\r\n\r\nnamespace ReproAddAlternativeFormatImportPartCorruption\r\n{\r\n    class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n            var iterations = 1;\r\n            var outputPath = $\"test_{DateTime.Now.ToString(\"yyyyMMdd-hhmmss\")}.docx\";\r\n            var attachmentPath = \"ExampleAttachment.docx\";\r\n            File.Copy(\"Template.docx\", outputPath);\r\n\r\n            var attachmentBytes = File.ReadAllBytes(attachmentPath);\r\n            using (var doc = WordprocessingDocument.Open(outputPath, true))\r\n            {\r\n                var firstPar = doc.MainDocumentPart.Document.Body.FirstChild;\r\n\r\n                for (int i = 0; i < iterations; i++)\r\n                {\r\n                    var attachmentHeading = $\"{attachmentPath} {i}\";\r\n                    var xmlFileId = attachmentHeading\r\n                        .Replace(\".\", \"_\")\r\n                        .Replace(\" \", \"_\");\r\n\r\n                    var compositeElements = AddDocumentAttachment(attachmentBytes, attachmentHeading, xmlFileId, doc.MainDocumentPart, AlternativeFormatImportPartType.WordprocessingML);\r\n                    foreach (var element in compositeElements)\r\n                    {\r\n                        firstPar.InsertBeforeSelf(element);\r\n                    }\r\n                }\r\n                doc.Save();\r\n            }\r\n\r\n        }\r\n\r\n        private static IEnumerable<OpenXmlCompositeElement> AddDocumentAttachment(\r\n            byte[] fileData, \r\n            string attachmentHeading, \r\n            string xmlFileId, \r\n            MainDocumentPart mainPart, \r\n            AlternativeFormatImportPartType? alternativeFormatImportPartType)\r\n        {\r\n\r\n            // Document is automatically saved and closed onDispose.\r\n            var chunk = mainPart.AddAlternativeFormatImportPart(alternativeFormatImportPartType.Value, xmlFileId);\r\n            using (var chunkStream = chunk.GetStream(FileMode.Create, FileAccess.Write))\r\n            using (var w = new BinaryWriter(chunkStream))\r\n            {\r\n                w.Write(fileData);\r\n                w.Flush();\r\n            }\r\n\r\n            var altChunk = new AltChunk\r\n            {\r\n                Id = xmlFileId\r\n            };\r\n\r\n            mainPart.Document.Save();\r\n\r\n            return new OpenXmlCompositeElement[]{\r\n                altChunk\r\n            };\r\n\r\n        }\r\n    }\r\n}\r\n``` \r\n\r\n**Observed**\r\n\r\nOpen the file in Word (Office 2019, version 1808, build 10372.20060), get the following error:\r\n\r\n\"We're sorry.  We can't open <documentname>.docx because we found a problem with its contents [OK] [Details]\r\n\r\nDetails:\r\n\r\nHRESULT 0x800004005\r\n\r\nLocation: Part: /word/document.xml, Line: 0, Column: 0\r\n\r\n**Expected**\r\n\r\nCreate a document that does not cause errors.\r\n\r\n** Additional notes**\r\n\r\nInitially I discovered this issue happening inconsistently - like, I would attach 4 documents and it would be okay, but 5 was too much.  And the only attached objects within the document were images.\r\n\r\nNow, I can raise it consistently with the method described above, using documents created from scratch.  If needed, I can send the docx files that will reproduce this issue.\r\n\r\nIf I use the same process *without* a shapes-line drawn into the files, the error does not occur."},{"Id":"15834832835","Type":"PullRequestEvent","CreatedAt":"2021-04-06T17:17:10","Actor":"tomjebo","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"opened","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/pull/916","RelatedDescription":"Opened pull request \"Additional O19 types to match Open Specifications\" (#916) at OfficeDev/Open-XML-SDK","RelatedBody":"schemas_microsoft_com_office_spreadsheetml_2018_threadedcomments.g.cs\r\nschemas_microsoft_com_office_powerpoint_2017_10_main.g.cs\r\nschemas_microsoft_com_office_powerpoint_2018_4_main.g.cs\r\nschemas_microsoft_com_office_drawing_2017_model3d.g.cs\r\nschemas_microsoft_com_office_drawing_2017_decorative.g.cs\r\nschemas_microsoft_com_office_drawing_2018_animation_model3d.g.cs\r\nschemas_microsoft_com_office_drawing_2018_animation.g.cs\r\nschemas_microsoft_com_office_drawing_2016_11_main.g.cs\r\n\r\n"}],"ResultType":"GitHubEvent"},"PowerTools":{"Events":[],"ResultType":"GitHubEvent"}},"RunOn":"2021-04-13T05:30:33.8459752Z","RunDurationInMilliseconds":775}