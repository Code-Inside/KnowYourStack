{"Data":{"Sdk":{"Events":[{"Id":"15204072647","Type":"PullRequestEvent","CreatedAt":"2021-02-16T18:24:54","Actor":"twsouthwick","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"merged","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/pull/885","RelatedDescription":"Merged pull request \"#883 Resolved issue with RelationshipErrorHandler producing malformed output\" (#885) at OfficeDev/Open-XML-SDK","RelatedBody":"I played around with a bunch of different ways to try to fix this and this was the cleanest I could come up with. Setting the `stream.Position = 0` didn't help. It seems nothing sets the original stream's length to the new smaller amount of bytes. Open to better ways of fixing this.\r\n\r\nI've updated malformed_uri.xlsx to include a super long URI and updated the tests to match to ensure we catch the issue.\r\n\r\nFixes #883 "},{"Id":"15204072614","Type":"IssuesEvent","CreatedAt":"2021-02-16T18:24:53","Actor":"twsouthwick","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"closed","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/issues/883","RelatedDescription":"Closed issue \"RelationshipErrorHandlerFactory fails with \"Data at the root level is invalid\"\" (#883) at OfficeDev/Open-XML-SDK","RelatedBody":"Using RelationshipErrorHandlerFactory.Rewrite with an output that is shorter than the original URI causes the output XML to be malformed in this Word document.\r\n\r\n```\r\n        static void Main(string[] args)\r\n        {\r\n            var doc = WordprocessingDocument.Open(\"BrokenURI.docx\", isEditable: true, new OpenSettings\r\n            {\r\n                RelationshipErrorHandlerFactory = _ => new RemoveMalformedHyperlinksRelationshipErrorHandler(),\r\n            });\r\n        }\r\n\r\n        private sealed class RemoveMalformedHyperlinksRelationshipErrorHandler : RelationshipErrorHandler\r\n        {\r\n            // Works\r\n            //public override string Rewrite(Uri partUri, string id, string uri) => $\"https://error{new string('r', uri.Length)}\";\r\n\r\n            // Fails with \"Data at the root level is invalid\"\r\n            public override string Rewrite(Uri partUri, string id, string uri) => $\"https://error\";\r\n        }\r\n```\r\n\r\nWhen the above is run on a Word document with the following document.xml.rels:\r\n\r\n```\r\n<Relationships xmlns=\"http://schemas.openxmlformats.org/package/2006/relationships\">\r\n\t<Relationship Id=\"rId8\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable\" Target=\"fontTable.xml\"/>\r\n\t<Relationship Id=\"rId3\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/settings\" Target=\"settings.xml\"/>\r\n\t<Relationship Id=\"rId7\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink\" Target=\"mailto:test@test.com;%20test2@test.com;%252test3@test.com;%20test3@test.com;%20test4@test.com;%20test5@test.com?subject=Unsubscribe%20Request&amp;body=Please%20unsubscribe%20me%20from%20all%20future%20communications\" TargetMode=\"External\"/>\r\n\t<Relationship Id=\"rId2\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles\" Target=\"styles.xml\"/>\r\n\t<Relationship Id=\"rId1\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/numbering\" Target=\"numbering.xml\"/>\r\n\t<Relationship Id=\"rId6\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/endnotes\" Target=\"endnotes.xml\"/>\r\n\t<Relationship Id=\"rId5\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/footnotes\" Target=\"footnotes.xml\"/>\r\n\t<Relationship Id=\"rId4\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/webSettings\" Target=\"webSettings.xml\"/>\r\n\t<Relationship Id=\"rId9\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme\" Target=\"theme/theme1.xml\"/>\r\n</Relationships>\r\n```\r\nIt fails with \"Data at the root level is invalid. Line 12, position 17.\" and has produced the following in the output document:\r\n\r\n```\r\n<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>\r\n<Relationships xmlns=\"http://schemas.openxmlformats.org/package/2006/relationships\">\r\n  <Relationship Id=\"rId8\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable\" Target=\"fontTable.xml\" />\r\n  <Relationship Id=\"rId3\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/settings\" Target=\"settings.xml\" />\r\n  <Relationship Id=\"rId7\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink\" Target=\"https://error\" TargetMode=\"External\" />\r\n  <Relationship Id=\"rId2\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles\" Target=\"styles.xml\" />\r\n  <Relationship Id=\"rId1\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/numbering\" Target=\"numbering.xml\" />\r\n  <Relationship Id=\"rId6\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/endnotes\" Target=\"endnotes.xml\" />\r\n  <Relationship Id=\"rId5\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/footnotes\" Target=\"footnotes.xml\" />\r\n  <Relationship Id=\"rId4\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/webSettings\" Target=\"webSettings.xml\" />\r\n  <Relationship Id=\"rId9\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme\" Target=\"theme/theme1.xml\" />\r\n</Relationships>l\"/><Relationship Id=\"rId9\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme\" Target=\"theme/theme1.xml\"/></Relationships>\r\n```\r\n\r\nAs you can see, the end part of the XML has now been malformed. This is probably a buffer issue with the shorter string being returned from the Rewrite method. I've seen this in a few places when working with the Package classes.\r\n\r\nExtending the Rewrite output to match the length of the original URI resolves the issue:\r\n\r\n`public override string Rewrite(Uri partUri, string id, string uri) => $\"https://error{new string('r', uri.Length)}\";`\r\n\r\n**Information**\r\n\r\n- .NET Target: .NET Core\r\n- DocumentFormat.OpenXml Version: 2.12.1\r\n\r\nPlease see example console app with sample Word document repo'ing the issue:\r\n\r\nhttps://github.com/Muppets/RelationshipErrorHandlerFactoryTest\r\n\r\n**Observed**\r\n\r\nException thrown: System.Xml.XmlException: 'Data at the root level is invalid. Line 12, position 17.'\r\n\r\n**Expected**\r\n\r\nInvalid URI is replaced with https://error\r\n\r\nJust as a footnote, I'm loving the new RelationshipErrorHandlerFactory support added recently, great work! ðŸŽ‰ \r\n"},{"Id":"15188077801","Type":"IssuesEvent","CreatedAt":"2021-02-15T14:39:01","Actor":"swiftinitdotcom","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"opened","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/issues/886","RelatedDescription":"Opened issue \"How to I clear cached excel chart underlying all charts values without user clicking on each chart refresh\" (#886) at OfficeDev/Open-XML-SDK","RelatedBody":"# Before submitting an issue, please fill this out\r\n\r\nIs this a:\r\n- [ ] Issue with the OpenXml library\r\n- [ ] Question on library usage- its a question\r\n\r\nIf you have answered that this is a question, please ask it on StackOverflow instead of here.\r\nThis issue tracker is meant to track product issues while StackOverflow excels at answering questions\r\n\r\n---------------- Remove this line and above before posting ----------------\r\n\r\n**Description**\r\n\r\nPlease provide a simple description of the issue encountered.\r\n\r\nI need to update all charts in embedded open xml based charts without user clicking on refresh\r\n\r\n- .NET Target: (ie .NET Framework, .NET Core, UWP, Xamarin, etc)\r\n- DocumentFormat.OpenXml Version: (ie 2.7.2)\r\n\r\n**Repro**\r\n\r\n```csharp\r\n// Please add a self-contained, minimum viable repro of the issue.\r\n// If you require external resources, please provide a gist or GitHub repro\r\n// An Xunit style test is preferred, but a console application would work too.\r\n``` \r\n\r\n**Observed**\r\n\r\nPlease add your observed behavior here\r\n\r\n**Expected**\r\n\r\nPlease add your expected behavior here.\r\n"},{"Id":"15174523182","Type":"PullRequestEvent","CreatedAt":"2021-02-13T18:46:38","Actor":"twsouthwick","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"reopened","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/pull/885","RelatedDescription":null,"RelatedBody":"I played around with a bunch of different ways to try to fix this and this was the cleanest I could come up with. Setting the `stream.Position = 0` didn't help. It seems nothing sets the original stream's length to the new smaller amount of bytes. Open to better ways of fixing this.\r\n\r\nI've updated malformed_uri.xlsx to include a super long URI and updated the tests to match to ensure we catch the issue.\r\n\r\nFixes #883 "},{"Id":"15174522986","Type":"PullRequestEvent","CreatedAt":"2021-02-13T18:46:35","Actor":"twsouthwick","Repository":"OfficeDev/Open-XML-SDK","Organization":"OfficeDev","RawContent":null,"RelatedAction":"closed","RelatedUrl":"https://github.com/OfficeDev/Open-XML-SDK/pull/885","RelatedDescription":"Closed pull request \"#883 Resolved issue with RelationshipErrorHandler producing malformed output\" (#885) at OfficeDev/Open-XML-SDK","RelatedBody":"I played around with a bunch of different ways to try to fix this and this was the cleanest I could come up with. Setting the `stream.Position = 0` didn't help. It seems nothing sets the original stream's length to the new smaller amount of bytes. Open to better ways of fixing this.\r\n\r\nI've updated malformed_uri.xlsx to include a super long URI and updated the tests to match to ensure we catch the issue.\r\n\r\nFixes #883 "}],"ResultType":"GitHubEvent"},"PowerTools":{"Events":[],"ResultType":"GitHubEvent"}},"RunOn":"2021-02-17T05:30:31.0472469Z","RunDurationInMilliseconds":859}